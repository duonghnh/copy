from flask import Flask, request, jsonify
from app.agent.manus import Manus
from app.logger import logger
import asyncio

app = Flask(__name__)

# Khởi tạo agent một lần khi server khởi động
agent = Manus()

@app.route('/api/process', methods=['POST'])
async def process_prompt():
    try:
        # Lấy dữ liệu từ request
        data = request.get_json()
        if not data or 'prompt' not in data:
            logger.warning("No prompt provided in request")
            return jsonify({
                'status': 'error',
                'message': 'Prompt is required'
            }), 400

        prompt = data['prompt'].strip()
        if not prompt:
            logger.warning("Empty prompt provided")
            return jsonify({
                'status': 'error',
                'message': 'Prompt cannot be empty'
            }), 400

        logger.info(f"Received prompt: {prompt}")
        logger.warning("Processing request...")

        # Chạy agent với prompt
        result = await agent.run(prompt)

        logger.info("Request processing completed")
        return jsonify({
            'status': 'success',
            'data': result
        }), 200

    except Exception as e:
        logger.error(f"Error processing request: {str(e)}")
        return jsonify({
            'status': 'error',
            'message': f"An error occurred: {str(e)}"
        }), 500

def run_app():
    # Chạy Flask app với asyncio
    app.run(host='0.0.0.0', port=5000, debug=True)

if __name__ == "__main__":
    # Sử dụng asyncio để chạy Flask app
    asyncio.run(run_app())
